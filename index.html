<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>万年历</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
    <script src="https://6tail.cn/tyme.min.js"></script> -->
  <script src="./vue.min.js"></script>
  <script src="./tyme.min.js"></script>
  <script src="./echarts.min.js"></script>
  <script src="./shensha.js"></script>
  <script src="./paipan.gx.js"></script>


  <style>
    @import url('./bazi.css?t=20251131');
  </style>
</head>

<body>

  <!-- 顶部控制区 -->
  <div class="top-controls-section">
    <!-- 第一排: 农历 + 三柱 -->
    <div class="control-row">
      <div class="input-card">
        <div class="card-head">
          <div>
            <p class="card-subtitle">Lunisolar</p>
            <h3>农历日期</h3>
          </div>
          <button id="btn-lunar2solar" class="ghost-btn">转为公历</button>
        </div>
        <div class="field-row">
          <label>
            <span>年份</span>
            <input id="lunar-year" type="number" placeholder="年" />
          </label>
          <label>
            <span>月份</span>
            <input id="lunar-month" type="number" placeholder="月" />
          </label>
          <label>
            <span>日期</span>
            <input id="lunar-day" type="number" placeholder="日" />
          </label>
        </div>
      </div>
      <div class="input-card">
        <div class="card-head">
          <div>
            <p class="card-subtitle">GanZhi</p>
            <h3>指定三柱</h3>
          </div>
          <button id="btn-pillar2solar" class="ghost-btn">推算公历</button>
        </div>
        <div class="field-row">
          <label>
            <span>年柱</span>
            <input id="pillar-year" type="text" placeholder="例：甲子" />
          </label>
          <label>
            <span>月柱</span>
            <input id="pillar-month" type="text" placeholder="例：乙丑" />
          </label>
          <label>
            <span>日柱</span>
            <input id="pillar-day" type="text" placeholder="例：丙寅" />
          </label>
        </div>
      </div>
    </div>

    <!-- 第二排: 公历 + 八字配置 -->
    <div class="control-row">
      <div class="input-card solar-card">
        <div class="card-head">
          <div>
            <p class="card-subtitle">Gregorian</p>
            <h3>公历日期</h3>
          </div>
          <button id="btn-today" class="ghost-btn">今天</button>
        </div>
        <div class="field-row">
          <label>
            <span>年份</span>
            <input id="solar-year" type="number" placeholder="年" />
          </label>
          <label>
            <span>月份</span>
            <input id="solar-month" type="number" placeholder="月" />
          </label>
          <label>
            <span>日期</span>
            <input id="solar-day" type="number" placeholder="日" />
          </label>
        </div>
      </div>

      <!-- 配置卡片 (整合样式) -->
      <div class="input-card config-card-inline">
        <div class="card-head">
          <div>
            <p class="card-subtitle">Configuration</p>
            <h3>八字配置</h3>
          </div>
          <button id="btn-apply-config" class="primary-btn">应用设置</button>
        </div>
        <div class="config-fields-inline">
          <!-- First Row: Simple Configs -->
          <div class="config-row-simple">
            <div class="config-group-inline">
              <label class="config-label">时分秒</label>
              <div class="time-inputs">
                <input id="cfg-hour" type="number" min="0" max="23" placeholder="时"> :
                <input id="cfg-minute" type="number" min="0" max="59" placeholder="分"> :
                <input id="cfg-second" type="number" min="0" max="59" placeholder="秒">
              </div>
            </div>
            <div class="config-group-inline">
              <label class="config-label">性别</label>
              <div class="radio-group">
                <label><input type="radio" name="cfg-gender" value="1" checked>男</label>
                <label><input type="radio" name="cfg-gender" value="0">女</label>
              </div>
            </div>
            <div class="config-group-inline">
              <label class="config-label">子时</label>
              <select id="cfg-provider">
                <option value="0">晚子时日柱算明天</option>
                <option value="1">晚子时日柱算当天</option>
              </select>
            </div>
            <div class="config-group-inline">
              <label class="config-label">流派</label>
              <select id="cfg-child-limit">
                <option value="0">默认</option>
                <option value="1">Lunar流派1</option>
                <option value="2">Lunar流派2</option>
                <option value="3">元亨利贞</option>
              </select>
            </div>
          </div>

          <!-- Second Row: True Solar Time (Full Width) -->
          <div class="config-row-solar">
            <div class="config-group-inline config-group-wide">
              <label class="config-label">真太阳时</label>
              <div class="true-solar-controls">
                <div class="solar-inputs-row">
                  <label class="toggle-switch">
                    <input id="cfg-true-solar-enable" type="checkbox">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">启用</span>
                  </label>
                  <div id="cfg-location-box" class="location-box" style="display: none;">
                    <select id="cfg-province" class="loc-select">
                      <option value="">省/市</option>
                    </select>
                    <select id="cfg-city" class="loc-select">
                      <option value="">市/区</option>
                    </select>
                    <select id="cfg-district" class="loc-select">
                      <option value="">区/县</option>
                    </select>
                  </div>
                </div>
                <div id="cfg-true-solar-display" class="ts-display" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- 标签导航栏 -->
    <div class="tabs-container">
      <ul class="tab-nav">
        <li class="tab-item active" data-tab="calendar">
          <span class="tab-icon">📅</span>
          <span class="tab-label">月历</span>
        </li>
        <li class="tab-item" data-tab="almanac">
          <span class="tab-icon">📖</span>
          <span class="tab-label">黄历</span>
        </li>
        <li class="tab-item" data-tab="bazi">
          <span class="tab-icon">🆕</span>
          <span class="tab-label">四柱八字</span>
        </li>
      </ul>

      <!-- 标签内容区 -->
      <div class="tab-content">
        <!-- Tab 1: 月历 -->
        <div class="tab-pane active" id="tab-calendar">
          <div class="main-content">
            <div id="demo-solar-month" class="month-calendar">


              <div id="calendar-date-display" class="solar"
                style="margin: 16px 0px 10px;text-align: center;font-size: 1rem;color: rgb(74, 85, 104);font-weight: 500;">
              </div>


              <div class="month">{{ month.name }}</div>

              <ul class="week">
                <li v-for="w in weeks" :class="{'weekend': w.isWeekend}">{{ w.name }}</li>
              </ul>
              <ul v-for="week in month.weeks">
                <li v-for="d in week.days" @click="selectDay(d)"
                  :class="{ 'holiday': d.holiday, 'holiday-work': d.holiday && d.holiday.isWork, 'weekend': d.isWeekend, 'gray': !d.isCurrentMonth, 'today': d.isToday, 'selected': isDaySelected(d), 'moon': d.moon, 'moon-0': d.moon && d.moonIndex === 0, 'moon-1': d.moon && d.moonIndex === 1, 'moon-2': d.moon && d.moonIndex === 2, 'moon-3': d.moon && d.moonIndex === 3, 'moon-4': d.moon && d.moonIndex === 4, 'moon-5': d.moon && d.moonIndex === 5, 'moon-6': d.moon && d.moonIndex === 6, 'moon-7': d.moon && d.moonIndex === 7 }">
                  <div>
                    <b>{{ d.day }}</b>
                    <i>{{ d.text }}</i>
                    <u v-if="d.holiday">{{ d.holiday.isWork ? '班' : '休' }}</u>
                    <u v-else-if="d.isToday">今</u>
                  </div>
                </li>
              </ul>
              <div href="javascript:void(0);" class="prev" @click="prevMonth" title="上月"></div>
              <div href="javascript:void(0);" class="next" @click="nextMonth" title="下月"></div>

              <div id="holiday-countdown"></div>
            </div>
          </div>
        </div>
        <!-- End Tab 1: 月历 -->

        <!-- Tab 2: 黄历 -->
        <div class="tab-pane" id="tab-almanac">
          <div class="main-content">
            <div id="demo-huangli" class="card">
              <div class="header">
                <div class="solar">{{solar}}</div>
                <div class="lunar">{{lunar}}</div>
                <div class="gz">{{gz}}</div>
              </div>
              <div class="yi"><i v-for="o in yi">{{o}}</i></div>
              <div class="ji"><i v-for="o in ji">{{o}}</i></div>
              <div class="table-wrapper">
                <table>
                  <tbody>
                    <tr>
                      <td>
                        <div><b>纳音</b><i>{{sound}}</i></div>
                      </td>
                      <td>
                        <div><b>冲煞</b><i>{{chongSha}}</i></div>
                      </td>
                      <td>
                        <div><b>值神</b><i>{{twelveStar}}</i></div>
                      </td>
                      <td>
                        <div><b>建除十二神</b><i>{{duty}}</i></div>
                      </td>
                      <td>
                        <div><b>二十八星宿</b><i>{{twentyEightStar}}</i></div>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        <div><b>财神</b><i>{{caishen}}</i></div>
                      </td>
                      <td>
                        <div><b>喜神</b><i>{{xishen}}</i></div>
                      </td>
                      <td>
                        <div><b>福神</b><i>{{fushen}}</i></div>
                      </td>
                      <td>
                        <div><b>贵神</b><i>{{guishen}}</i></div>
                      </td>
                      <td>
                        <div><b>今日胎神</b><i>{{fetus}}</i></div>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="5">
                        <div><b>彭祖百忌</b><i><span v-for="o in pz">{{o}} </span></i></div>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="2">
                        <div><b>吉神宜趋</b>
                          <ul>
                            <li v-for="o in god.ji">{{o}}</li>
                          </ul>
                        </div>
                      </td>
                      <td colspan="3">
                        <div><b>凶神宜忌</b>
                          <ul>
                            <li v-for="o in god.xiong">{{o}}</li>
                          </ul>
                        </div>
                      </td>
                    </tr>
                    <tr>
                      <td colspan="5" class="shichen-cell">
                        <div><b>时辰吉凶</b></div>
                        <ul class="hours-list">
                          <li v-for="(h, index) in hours" @click="selectHour(index)"
                            :class="{selected: index === selectedHourIndex}">
                            <div>{{h.sixtyCycle.string}}</div>
                            <div :class="h.luck === '吉' ? 'good' : 'bad'">{{h.luck}}</div>
                          </li>
                        </ul>
                        <div class="hour-details" v-if="selectedHour">
                          <div class="hour-luck-header">
                            <span class="hour-luck-badge"
                              :class="selectedHour.luck === '吉' ? 'good' : 'bad'">{{selectedHour.luck}}</span>
                            <span class="hour-time-info">{{selectedHour.sixtyCycle.string}}时
                              {{selectedHour.timeRange}}</span>
                          </div>
                          <p class="hour-meta">
                            <span>{{selectedHour.clash}}</span>
                            <span>喜神{{selectedHour.joyDirection}}</span>
                            <span>财神{{selectedHour.wealthDirection}}</span>
                            <span>福神{{selectedHour.mascotDirection}}</span>
                          </p>
                          <p class="hour-yi"><span class="yi">{{selectedHour.recommends.join(' ')}}</span></p>
                          <p class="hour-ji"><span class="ji">{{selectedHour.avoids.join(' ')}}</span></p>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- End Tab 2: 黄历 -->

        <!-- Tab 3: 四柱八字 (includes all bazi-related content) -->
        <div class="tab-pane" id="tab-bazi">
          <div id="demo-eight-char" class="main-content">
            <div class="card">
              <!-- Date Info (Optimized Layout) -->
              <div class="date-info-container"
                style="display: flex; gap: 20px; margin-bottom: 24px; padding: 16px;  border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                <div class="date-card"
                  style="flex: 1; background: rgba(255, 255, 255, 0.95); padding: 16px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  <p class="date-label"
                    style="font-size: 13px; color: #667eea; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                    公历 Solar</p>
                  <p class="date-value"
                    style="font-size: 16px; color: #2d3748; font-weight: 500; margin: 0; line-height: 1.5;">{{ solarStr
                    }}</p>
                </div>
                <div class="date-card"
                  style="flex: 1; background: rgba(255, 255, 255, 0.95); padding: 16px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  <p class="date-label"
                    style="font-size: 13px; color: #764ba2; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                    农历 Lunar</p>
                  <p class="date-value"
                    style="font-size: 16px; color: #2d3748; font-weight: 500; margin: 0; line-height: 1.5;">{{ lunarStr
                    }}</p>
                </div>
              </div>
              <div class="eight-char bazi-chart-grid">
                <!-- Labels Column (PC Only) -->
                <div class="chart-column labels-column">
                  <div class="cell header">四柱</div>
                  <div class="cell">主星</div>
                  <div class="cell cell-stem">天干</div>
                  <div class="cell cell-branch">地支</div>
                  <div class="cell cell-hide">藏干</div>
                  <div class="cell">星运</div>
                  <div class="cell">自坐</div>
                  <div class="cell">空亡</div>
                  <div class="cell">纳音</div>
                  <div class="cell cell-shensha">神煞</div>
                </div>

                <!-- Year Pillar -->
                <div class="chart-column pillar-column">
                  <div class="cell header">年柱</div>
                  <div class="cell"><span class="mobile-label">主星</span>{{ year.tenStar.heavenStem }}</div>
                  <div class="cell cell-stem">
                    <span class="mobile-label">天干</span>
                    <b :class="['wuxing-badge', getWuXingClass(year.heavenStem)]">
                      <span>{{ year.heavenStem }}</span>
                      <img v-if="getWuXingIcon(year.heavenStem)" :src="getWuXingIcon(year.heavenStem)"
                        :alt="year.heavenStem">
                    </b>
                  </div>
                  <div class="cell cell-branch">
                    <span class="mobile-label">地支</span>
                    <b :class="['wuxing-badge', getWuXingClass(year.earthBranch)]">
                      <span>{{ year.earthBranch }}</span>
                      <img v-if="getWuXingIcon(year.earthBranch)" :src="getWuXingIcon(year.earthBranch)"
                        :alt="year.earthBranch">
                    </b>
                  </div>
                  <div class="cell cell-hide">
                    <span class="mobile-label">藏干</span>
                    <ol>
                      <li v-for="(o, i) in year.hideHeavenStems" :key="i">
                        <b :class="['wuxing-badge', 'hide-stem', getWuXingClass(o.name)]">
                          <span>{{ o.name }}</span>
                        </b>
                        <i>{{ o.tenStar }}</i>
                      </li>
                    </ol>
                  </div>
                  <div class="cell"><span class="mobile-label">星运</span>{{ year.terrain }}</div>
                  <div class="cell"><span class="mobile-label">自坐</span>{{ year.terrainSelf }}</div>
                  <div class="cell">
                    <span class="mobile-label">空亡</span>
                    <div class="empty-wrapper">
                      <b v-for="(o, i) in year.extraEarthBranches" :key="i"
                        :class="['wuxing-badge', 'empty-branch', getWuXingClass(o)]">
                        <span>{{ o }}</span>
                      </b>
                    </div>
                  </div>
                  <div class="cell"><span class="mobile-label">纳音</span>{{ year.sound }}</div>
                  <div class="cell cell-shensha">
                    <span class="mobile-label">神煞</span>
                    <div class="shensha-tags">
                      <span v-for="s in year.shensha" :key="s">{{ s }}</span>
                    </div>
                  </div>
                </div>

                <!-- Month Pillar -->
                <div class="chart-column pillar-column">
                  <div class="cell header">月柱</div>
                  <div class="cell"><span class="mobile-label">主星</span>{{ month.tenStar.heavenStem }}</div>
                  <div class="cell cell-stem">
                    <span class="mobile-label">天干</span>
                    <b :class="['wuxing-badge', getWuXingClass(month.heavenStem)]">
                      <span>{{ month.heavenStem }}</span>
                      <img v-if="getWuXingIcon(month.heavenStem)" :src="getWuXingIcon(month.heavenStem)"
                        :alt="month.heavenStem">
                    </b>
                  </div>
                  <div class="cell cell-branch">
                    <span class="mobile-label">地支</span>
                    <b :class="['wuxing-badge', getWuXingClass(month.earthBranch)]">
                      <span>{{ month.earthBranch }}</span>
                      <img v-if="getWuXingIcon(month.earthBranch)" :src="getWuXingIcon(month.earthBranch)"
                        :alt="month.earthBranch">
                    </b>
                  </div>
                  <div class="cell cell-hide">
                    <span class="mobile-label">藏干</span>
                    <ol>
                      <li v-for="(o, i) in month.hideHeavenStems" :key="i">
                        <b :class="['wuxing-badge', 'hide-stem', getWuXingClass(o.name)]">
                          <span>{{ o.name }}</span>
                        </b>
                        <i>{{ o.tenStar }}</i>
                      </li>
                    </ol>
                  </div>
                  <div class="cell"><span class="mobile-label">星运</span>{{ month.terrain }}</div>
                  <div class="cell"><span class="mobile-label">自坐</span>{{ month.terrainSelf }}</div>
                  <div class="cell">
                    <span class="mobile-label">空亡</span>
                    <div class="empty-wrapper">
                      <b v-for="(o, i) in month.extraEarthBranches" :key="i"
                        :class="['wuxing-badge', 'empty-branch', getWuXingClass(o)]">
                        <span>{{ o }}</span>
                      </b>
                    </div>
                  </div>
                  <div class="cell"><span class="mobile-label">纳音</span>{{ month.sound }}</div>
                  <div class="cell cell-shensha">
                    <span class="mobile-label">神煞</span>
                    <div class="shensha-tags">
                      <span v-for="s in month.shensha" :key="s">{{ s }}</span>
                    </div>
                  </div>
                </div>

                <!-- Day Pillar -->
                <div class="chart-column pillar-column">
                  <div class="cell header">日柱</div>
                  <div class="cell"><span class="mobile-label">主星</span>{{ day.tenStar.heavenStem }}</div>
                  <div class="cell cell-stem">
                    <span class="mobile-label">天干</span>
                    <b :class="['wuxing-badge', getWuXingClass(day.heavenStem)]">
                      <span>{{ day.heavenStem }}</span>
                      <img v-if="getWuXingIcon(day.heavenStem)" :src="getWuXingIcon(day.heavenStem)"
                        :alt="day.heavenStem">
                    </b>
                  </div>
                  <div class="cell cell-branch">
                    <span class="mobile-label">地支</span>
                    <b :class="['wuxing-badge', getWuXingClass(day.earthBranch)]">
                      <span>{{ day.earthBranch }}</span>
                      <img v-if="getWuXingIcon(day.earthBranch)" :src="getWuXingIcon(day.earthBranch)"
                        :alt="day.earthBranch">
                    </b>
                  </div>
                  <div class="cell cell-hide">
                    <span class="mobile-label">藏干</span>
                    <ol>
                      <li v-for="(o, i) in day.hideHeavenStems" :key="i">
                        <b :class="['wuxing-badge', 'hide-stem', getWuXingClass(o.name)]">
                          <span>{{ o.name }}</span>
                        </b>
                        <i>{{ o.tenStar }}</i>
                      </li>
                    </ol>
                  </div>
                  <div class="cell"><span class="mobile-label">星运</span>{{ day.terrain }}</div>
                  <div class="cell"><span class="mobile-label">自坐</span>{{ day.terrainSelf }}</div>
                  <div class="cell">
                    <span class="mobile-label">空亡</span>
                    <div class="empty-wrapper">
                      <b v-for="(o, i) in day.extraEarthBranches" :key="i"
                        :class="['wuxing-badge', 'empty-branch', getWuXingClass(o)]">
                        <span>{{ o }}</span>
                      </b>
                    </div>
                  </div>
                  <div class="cell"><span class="mobile-label">纳音</span>{{ day.sound }}</div>
                  <div class="cell cell-shensha">
                    <span class="mobile-label">神煞</span>
                    <div class="shensha-tags">
                      <span v-for="s in day.shensha" :key="s">{{ s }}</span>
                    </div>
                  </div>
                </div>

                <!-- Hour Pillar -->
                <div class="chart-column pillar-column">
                  <div class="cell header">时柱</div>
                  <div class="cell"><span class="mobile-label">主星</span>{{ hour.tenStar.heavenStem }}</div>
                  <div class="cell cell-stem">
                    <span class="mobile-label">天干</span>
                    <b :class="['wuxing-badge', getWuXingClass(hour.heavenStem)]">
                      <span>{{ hour.heavenStem }}</span>
                      <img v-if="getWuXingIcon(hour.heavenStem)" :src="getWuXingIcon(hour.heavenStem)"
                        :alt="hour.heavenStem">
                    </b>
                  </div>
                  <div class="cell cell-branch">
                    <span class="mobile-label">地支</span>
                    <b :class="['wuxing-badge', getWuXingClass(hour.earthBranch)]">
                      <span>{{ hour.earthBranch }}</span>
                      <img v-if="getWuXingIcon(hour.earthBranch)" :src="getWuXingIcon(hour.earthBranch)"
                        :alt="hour.earthBranch">
                    </b>
                  </div>
                  <div class="cell cell-hide">
                    <span class="mobile-label">藏干</span>
                    <ol>
                      <li v-for="(o, i) in hour.hideHeavenStems" :key="i">
                        <b :class="['wuxing-badge', 'hide-stem', getWuXingClass(o.name)]">
                          <span>{{ o.name }}</span>
                        </b>
                        <i>{{ o.tenStar }}</i>
                      </li>
                    </ol>
                  </div>
                  <div class="cell"><span class="mobile-label">星运</span>{{ hour.terrain }}</div>
                  <div class="cell"><span class="mobile-label">自坐</span>{{ hour.terrainSelf }}</div>
                  <div class="cell">
                    <span class="mobile-label">空亡</span>
                    <div class="empty-wrapper">
                      <b v-for="(o, i) in hour.extraEarthBranches" :key="i"
                        :class="['wuxing-badge', 'empty-branch', getWuXingClass(o)]">
                        <span>{{ o }}</span>
                      </b>
                    </div>
                  </div>
                  <div class="cell"><span class="mobile-label">纳音</span>{{ hour.sound }}</div>
                  <div class="cell cell-shensha">
                    <span class="mobile-label">神煞</span>
                    <div class="shensha-tags">
                      <span v-for="s in hour.shensha" :key="s">{{ s }}</span>
                    </div>
                  </div>
                </div>
              </div>


              <!-- 刑冲破害合关系 (Refined Display) -->
              <div class="relationships-container" v-if="relationships">
                <h3 class="relationships-title">
                  刑冲破害合关系
                </h3>
                <div class="relationships-content">
                  <div v-if="relationships.stems && relationships.stems.length > 0" class="relationship-group">
                    <div class="relationship-group-label">
                      天干关系</div>
                    <div class="relationship-tags">
                      <div v-for="(rel, idx) in relationships.stems" :key="'s'+idx"
                        class="relationship-tag stem-relation">
                        <span class="rel-source">{{ rel.source }}</span>
                        <span class="rel-desc">{{ rel.desc }}</span>
                      </div>
                    </div>
                  </div>
                  <div v-if="relationships.branches && relationships.branches.length > 0" class="relationship-group">
                    <div class="relationship-group-label">
                      地支关系</div>
                    <div class="relationship-tags">
                      <div v-for="(rel, idx) in relationships.branches" :key="'b'+idx"
                        class="relationship-tag branch-relation">
                        <span class="rel-source">{{ rel.source }}</span>
                        <span class="rel-desc">{{ rel.desc }}</span>
                      </div>
                    </div>
                  </div>
                  <div
                    v-if="(!relationships.stems || relationships.stems.length === 0) && (!relationships.branches || relationships.branches.length === 0)"
                    class="relationship-empty">
                    无明显刑冲破害合关系
                  </div>
                </div>
              </div>
              </details>
            </div>



            <!-- 五行能量分析 (previously Tab 4 content, now merged into Tab 3) -->
            <!-- 五行能量分析 -->
            <div class="wuxing-energy-analysis" v-if="wuxingEnergy">
              <div class="section-head">
                <div>
                  <h3>五行能量分析</h3>
                  <p>综合干支数量、藏干深浅、宫位权重与刑冲破害合的影响</p>
                </div>
                <div class="balance-index">
                  <span>平衡指数</span>
                  <strong>{{ wuxingEnergy.balanceIndex.toFixed(1) }}%</strong>
                </div>
              </div>
              <div class="energy-charts-container">
                <div id="wuxing-radar-chart" class="chart-box"></div>
                <div id="wuxing-pie-chart" class="chart-box"></div>
              </div>
              <div class="energy-grid">
                <div class="energy-card" v-for="item in wuxingEnergy.elements" :key="item.id">
                  <div class="card-header">
                    <span class="name" :class="'text-wuxing-' + item.id">{{ item.name }}</span>
                    <span class="level">{{ item.level }}</span>
                  </div>
                  <div class="energy-bar-container">
                    <div class="energy-bar" :class="item.id" :style="{ width: item.percentage + '%' }"></div>
                    <span class="energy-label">{{ item.percentage.toFixed(1) }}%</span>
                  </div>
                  <div class="values">
                    <span>得分 {{ item.score.toFixed(2) }}</span>
                    <span>占比 {{ item.percentage.toFixed(1) }}%</span>
                  </div>
                  <p class="analysis">{{ item.analysis }}</p>
                  <div class="derivation" v-if="item.derivation && item.derivation.length">
                    <div class="derivation-title">推导记录</div>
                    <ul>
                      <li v-for="(log, idx) in item.derivation" :key="idx">
                        <span class="reason">{{ log.reason }}</span>
                        <span class="value">{{ formatDerivationStep(log) }}</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- 计算规则说明 -->
              <div class="calculation-rules" v-if="wuxingEnergy">
                <details>
                  <summary class="rules-header">
                    <h4>能量计算规则说明 (点击展开)</h4>
                    <div class="total-score">
                      <span>总能量分：</span>
                      <strong>{{ wuxingEnergy.totalScore.toFixed(2) }}</strong>
                    </div>
                  </summary>
                  <div class="rules-content">
                    <div class="rule-section">
                      <h5>基础能量单位（Base Units）</h5>
                      <ul>
                        <li><strong>天干（显露之气）：</strong>10 BU/个</li>
                        <li><strong>地支（根基之气）：</strong>
                          <ul>
                            <li>普通地支：20 BU</li>
                            <li>月支（提纲）：40 BU（2倍权重）</li>
                          </ul>
                        </li>
                        <li><strong>藏干（按比例分配地支能量）：</strong>
                          <ul>
                            <li>专气(子/卯/酉)：本气 100%</li>
                            <li>专气带土(午)：丁70% + 己30%</li>
                            <li>四生(寅/申/巳/亥)：本气60% + 中气30% + 余气10%</li>
                            <li>四库(辰/戌/丑/未)：本气60% + 中气25% + 余气15%</li>
                          </ul>
                        </li>
                      </ul>
                    </div>
                    <div class="rule-section">
                      <h5>专业调整流程（资深命理师标准）</h5>
                      <ul>
                        <li><strong>Step 1: 静态初始化</strong> - 按上述基础单位赋值</li>
                        <li><strong>Step 2: 空亡检查</strong> - 空亡地支及藏干 ×0.5</li>
                        <li><strong>Step 3: 提纲加权（断崖式惩罚）</strong>
                          <ul>
                            <li>旺（同月令）：×1.5</li>
                            <li>相（月令所生）：×1.2</li>
                            <li>休（生月令者）：×0.7</li>
                            <li>囚（克月令者）：×0.4 ⚠️</li>
                            <li>死（月令所克）：×0.2 ⚠️ 大幅削弱</li>
                          </ul>
                        </li>
                        <li><strong>Step 4: 地支强局计算</strong>
                          <ul>
                            <li>三会方局（寅卯辰/巳午未等）：能量 ×2.0（最高优先级）</li>
                            <li>三合局（申子辰/亥卯未等）：成功时 ×1.8，半合 ×1.3</li>
                            <li>合局可解除50%空亡削减</li>
                          </ul>
                        </li>
                        <li><strong>Step 5: 地支刑冲判定</strong>
                          <ul>
                            <li>土土相冲（辰戌/丑未）：土本气 ×1.4，藏干杂气 ×0.1</li>
                            <li>金木水火相冲：旺者 ×0.9，衰者 ×0.6</li>
                            <li>仅处理未参与合局的地支</li>
                          </ul>
                        </li>
                        <li><strong>Step 6: 天干合化判定</strong>
                          <ul>
                            <li>月令支持化神（≥1.5）：完全合化，能量 ×1.5</li>
                            <li>月令不支持：合而不化（羁绊），双方 ×0.8</li>
                          </ul>
                        </li>
                        <li><strong>Step 7: 通根透干系数（假神判定）</strong>
                          <ul>
                            <li>强根（本气相同）：天干 ×1.2</li>
                            <li>中根（中气相同）：天干 ×1.0</li>
                            <li>弱根（余气相同）：天干 ×0.8</li>
                            <li>无根（虚浮）：天干 ×0.1 ⚠️ 视为假神，忽略不计</li>
                          </ul>
                        </li>
                        <li><strong>❌ Step 8: 生克迭代已移除</strong>
                          <ul>
                            <li>原因：迭代会平滑化强弱悬殊，掩盖"病药"格局</li>
                            <li>保留静态分布，清晰展现谁强谁弱</li>
                            <li>更符合资深命理师的判断标准</li>
                          </ul>
                        </li>
                      </ul>
                    </div>
                    <div class="rule-section">
                      <h5>核心特征（资深命理师版）</h5>
                      <ul>
                        <li>✅ 月支获得 <strong>2倍权重</strong>（40 BU vs 20 BU）</li>
                        <li>✅ 藏干按 <strong>标准比例</strong> 分配（非固定分值）</li>
                        <li>🔥 失令大幅惩罚：休=0.7, 囚=0.4, <strong>死=0.2</strong></li>
                        <li>✅ 土土相冲 <strong>特殊处理</strong>（本气旺+杂气灭）</li>
                        <li>✅ 通根使用 <strong>系数方式</strong>（非加分方式）</li>
                        <li>💧 无根虚浮 <strong>×0.1</strong>（假神不如真神）</li>
                        <li>✅ 天干合化取决于 <strong>月令是否得力</strong></li>
                        <li>❌ <strong>不做生克迭代</strong>（保留静态强弱悬殊）</li>
                        <li>✅ 详细推导日志记录每一步变化</li>
                      </ul>
                      <div
                        style="margin-top: 16px; padding: 12px; background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 4px;">
                        <strong>⚡ 核心理念：</strong> 不追求"平衡"，而是精确展现"失衡"状态，让用户清晰看到命局的"病"在哪里，"药"在何处。更符合专业命理分析的思路。
                      </div>
                    </div>
                  </div>
              </div>
            </div>

            <!-- 深度格局分析 (Compact Version) -->
            <div class="advanced-analysis-compact" v-if="wuxingEnergy && wuxingEnergy.summary">
              <div class="compact-header">
                <h3>格局分析</h3>
              </div>

              <div class="compact-content">
                <!-- 格局判定 -->
                <div class="compact-row">
                  <div class="compact-label">格局</div>
                  <div class="compact-value pattern-value">{{ wuxingEnergy.summary }}</div>
                </div>

                <!-- 调候建议 -->
                <div class="compact-row">
                  <div class="compact-label">调候</div>
                  <div class="compact-value climate-value">{{ wuxingEnergy.climate || '需结合全局寒暖湿燥综合判断' }}</div>
                </div>

                <!-- 喜用神 -->
                <div class="compact-row">
                  <div class="compact-label">喜用</div>
                  <div class="compact-value gods-value">
                    <span class="god-tag joy" v-for="god in wuxingEnergy.preferences.likes" :key="god">{{ god }}</span>
                    <span v-if="!wuxingEnergy.preferences.likes || wuxingEnergy.preferences.likes.length === 0"
                      class="god-empty">—</span>
                  </div>
                </div>

                <!-- 忌神 -->
                <div class="compact-row">
                  <div class="compact-label">忌讳</div>
                  <div class="compact-value gods-value">
                    <span class="god-tag avoid" v-for="god in wuxingEnergy.preferences.dislikes" :key="god">{{ god
                      }}</span>
                    <span v-if="!wuxingEnergy.preferences.dislikes || wuxingEnergy.preferences.dislikes.length === 0"
                      class="god-empty">—</span>
                  </div>
                </div>

                <!-- 综合建议 -->
                <div class="compact-row suggestion-row">
                  <div class="compact-label">建议</div>
                  <div class="compact-value suggestion-value">{{ wuxingEnergy.suggestion || '请结合五行能量分析判断' }}</div>
                </div>
              </div>

              <!-- 推导细节 -->
              <details class="compact-logs">
                <summary>查看细节</summary>
                <ul>
                  <li v-for="(log, idx) in wuxingEnergy.logs" :key="idx">{{ log }}</li>
                </ul>
              </details>
            </div>
            <div class="fortune">
              <div class="info-row">
                <div class="info-card wide">
                  <p class="label">胎元 / 胎息</p>
                  <p class="value">胎元：{{ fetalOrigin.name }}({{ fetalOrigin.sound }})　胎息：{{ fetalBreath.name }}({{
                    fetalBreath.sound }})</p>
                </div>
                <div class="info-card">
                  <p class="label">节气</p>
                  <p class="value">{{ prevTerm.name }}({{ prevTerm.time }}) {{ nextTerm.name }}({{ nextTerm.time }})
                  </p>
                </div>
              </div>
              <div class="info-row">
                <div class="info-card">
                  <p class="label">命宫 / 身宫</p>
                  <p class="value">命宫：{{ ownSign.name }}({{ ownSign.sound }})<br>身宫：{{ bodySign.name }}({{
                    bodySign.sound
                    }})</p>
                </div>
                <div class="info-card wide">
                  <p class="label">起运信息</p>
                  <p class="value">{{ childLimitInfo.year }}年{{ childLimitInfo.month }}个月{{ childLimitInfo.day }}天{{
                    childLimitInfo.hour }}时{{ childLimitInfo.minute }}分后起运<br>(公历 {{ childLimitInfo.endSolarTime }})
                  </p>
                </div>
              </div>
              <ul>
                <li class="title">大运</li>
                <li v-for="(o, i) in decadeFortunes" :key="i" @click="onSelectDecadeFortune(i)"
                  :class="{'selected': selected.decadeFortune == i}">
                  <b>{{ o.sixtyCycle }}</b>
                  <i>{{ o.startYear }}</i>
                  <i>{{ o.endYear }}</i>
                  <span>{{ o.startAge }} - {{ o.endAge }}岁</span>
                  <u>{{ o.tenStar }}</u>
                </li>
              </ul>
              <ul style="margin-top: 10px">
                <li class="title">小运</li>
                <li v-for="(o, i) in fortunes" :key="i" @click="onSelectFortune(i)"
                  :class="{'selected': selected.fortune == i}">
                  <b>{{ o.sixtyCycle }}</b>
                  <i>{{ o.year.year }}</i>
                  <span>{{ o.age }}岁</span>
                  <u>{{ o.tenStar }}</u>
                </li>
              </ul>
              <ul>
                <li class="title">流年</li>
                <li v-for="(o, i) in fortunes" :key="i" @click="onSelectFortune(i)"
                  :class="{'selected': selected.fortune == i}">
                  <b>{{ o.year.sixtyCycle }}</b>
                  <u>{{ o.year.tenStar }}</u>
                </li>
              </ul>
              <ul>
                <li class="title">流月</li>
                <li v-for="(o, i) in months" :key="i">
                  <b>{{ o.sixtyCycle }}</b>
                  <u>{{ o.tenStar }}</u>
                </li>
              </ul>
            </div>

            <!-- AI分析专用格式化文本 (previously Tab 5 content, now merged into Tab 3) -->
            <div class="copy-container">
              <div class="copy-header">
                <div>
                  <h3>AI分析专用格式化文本</h3>
                  <p>结构化输出，方便粘贴到报告/解读工具</p>
                </div>
                <button id="btn-copy-bazi" class="copy-btn">
                  <span>复制全文</span>
                </button>
              </div>
              <textarea id="bazi-summary" class="copy-textarea" readonly></textarea>
              <div class="copy-footer">
                <span>内容为只读，如需调整请在上方参数修改后重新生成。</span>
              </div>
            </div>
          </div>
          <!-- End demo-eight-char / main-content -->
        </div>
        <!-- End Tab 3: 四柱八字 (now includes all bazi content) -->
      </div>
      <!-- End tab-content -->
    </div>
    <!-- End tabs-container -->
  </div>
  <!-- End container -->

  <!-- Usage Guide Section -->
  <details class="usage-guide">
    <summary class="usage-guide-summary">
      <span class="guide-icon">📖</span>
      <span class="guide-title">使用指南</span>
      <span class="guide-toggle">点击展开</span>
    </summary>

    <div class="usage-guide-content">
      <h3>1. 基础排盘</h3>
      <ol>
        <li>在页面顶部的日历区域选择日期，或直接在"八字配置"中输入时间。</li>
        <li>选择性别（男/女）。</li>
        <li>点击 <strong>"应用设置"</strong> 生成排盘。</li>
      </ol>

      <h3>2. 启用真太阳时 (推荐)</h3>
      <p>为了获得最准确的出生时辰，建议开启此功能：</p>
      <ol>
        <li>找到 <strong>"八字配置"</strong> 卡片。</li>
        <li>勾选 <strong>"真太阳 - 启用"</strong> 复选框。</li>
        <li>在弹出的下拉框中，依次选择出生地的 <strong>省 - 市 - 区/县</strong>。
        <li>下方会实时显示计算后的 <strong>"真太阳时"</strong>。</li>
        <li>点击 <strong>"应用设置"</strong>，系统将按真太阳时重新排盘。</li>
      </ol>

      <h3>3. 查看分析结果</h3>
      <ul>
        <li><strong>八字排盘</strong>：查看四柱、十神、神煞等核心信息。</li>
        <li><strong>五行能量</strong>：查看五行分数、雷达图和旺衰分析。</li>
        <li><strong>AI 分析提示</strong>：在页面底部，点击 <strong>"复制内容"</strong> 按钮，将排盘摘要复制给 AI 助手（如
          Gemini、DeepSeek、ChatGPT、Qwen、Claude等），获取详细的命理解读。
        </li>
      </ul>

      <h3>🛠 技术说明</h3>
      <ul>
        <li><strong>核心算法</strong>：基于 <code>lunar-javascript</code> 和 <code>tyme</code> 库，结合 Jean Meeus 天文算法实现高精度时间计算。
        </li>
        <li><strong>数据源</strong>：地理位置数据基于国测局坐标系 (GCJ-02)，经度误差在秒级，完全满足命理计算需求。</li>
      </ul>
    </div>
  </details>

  <script src="./bazi.js?t=20251131"></script>



</body>

</html>
